<!doctype html>
<html lang="cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>table</title>

    <!-- Bootstrap core CSS -->
    <link href="../../bootstrap-4.1.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <!--<link href="dashboard.css" rel="stylesheet">-->
</head>

<body>
<div class="container-fluid">
    <main role="main" class="col-md-auto ml-sm-auto col-lg-auto px-4" id="contentRoot">
        <!--<div class="nav nav-pills nav-fill d-flex justify-content-start">-->
        <h3>表字段&nbsp;&nbsp;
            &nbsp;&nbsp;<a class="text-success" data-feather="refresh-cw" onclick="getTableInfor()"></a>
            &nbsp;&nbsp;
            &nbsp;&nbsp;</a><a class="text-warning" data-feather="save" onclick="save()"></a>
        </h3>
        <!--</div>-->
        <div class="table-responsive pt-3 pb-2 mb-3 border-bottom">
            <table class="table table-striped table-sm">
                <thead>
                <tr>
                    <th>操作</th>
                    <th>字段ID</th>
                    <th>字段类型</th>
                    <th>主键</th>
                    <th>缓存键</th>
                    <th>组主键</th>
                    <th>字段说明</th>
                </tr>
                </thead>
                <tbody id="tabledesigninfor">
                </tbody>
            </table>
        </div>
    </main>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>window.jQuery || document.write('<script src="../../../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="../../bootstrap-4.1.1/assets/js/vendor/popper.min.js"></script>
<script src="../../bootstrap-4.1.1/dist/js/bootstrap.min.js"></script>
<script src="../../Bootstrap-Confirmation-master/dist/bootstrap-confirmation.js"></script>

<script src="js/jquery.url.js"></script>
<script src="js/myutl.js"></script>

<!-- Icons -->
<script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
<script>
    var tableName = $.url.param("id")
    var baseUrl = $.url.param("url")
    var tabledesign;
    var currpageIndex = 0;

    $("#contentRoot2").hide();

    function iscachekey(key) {
        for (var k in tabledesign.cacheKey) {
            if (key == tabledesign.cacheKey[k]) {
                return true;
            }
        }
        return false;
    }

    function isprimarykey(key) {
        for (var k in tabledesign.primaryKey) {
            if (key == tabledesign.primaryKey[k]) {
                return true;
            }
        }
        return false;
    }

    function isgroupkey(key) {
        if (key == tabledesign.groupKey) {
            return true;
        }
        return false;
    }

    //保存
    function save() {

    }

    //增加字段
    function addrow() {
        var key = $("#new-row-key").val();
        var type = $("#new-row-type").val();
        var primarykey = $("#new-row-primarykey").val();
        var cachekey = $("#new-row-cachekey").val();
        var groupkey = $("#new-row-groupkey").val();
        var desc = $("#new-row-desc").val();

        //判断是否已经当前key
        for (var k in tabledesign.columns) {
            if (key == (tabledesign.columns[k])[0]) {
                alert("已经有同名字段！")
                return;
            }
        }

        var col = [];
        col.push(key);
        col.push(type);
        col.push(desc);
        tabledesign.columns.push(col);


        var d = col;
        tabledesign.columnsmap[d[0]] = d;
        var tr = "<tr id='row-" + k + "'>";
        tr = tr + "<td ><a class='row-del text-danger' data-feather=\"minus-circle\" data-toggle=\"confirmation\" data-singleton=\"true\" data-title=\"确认要删除?\"></a></td>";
        tr = tr + "<td id='row-key'>" + d[0] + "</td>";
        tr = tr + "<td id='row-type'><input value='" + d[1] + "'></td>";
        tr = tr + "<td id='row-primarykey'><input type='checkbox' " + (isprimarykey(d[0]) ? "checked" : "") + "></td>";
        tr = tr + "<td id='row-cachekey'><input type='checkbox' " + (iscachekey(d[0]) ? "checked" : "") + "></td>";
        tr = tr + "<td ><input id='row-groupkey' name='options-groupkey' " + (isgroupkey(d[0]) ? "checked" : "") + " autocomplete=\"off\" type='radio'></td>";
        tr = tr + "<td ><input id='row-desc' value='" + d[2] + "'></td>";
        tr = tr + "</tr>";
        $("#tabledesigninfor").append(tr).ready(function () {
            $('[data-toggle=confirmation]').confirmation({
                rootSelector: '[data-toggle=confirmation]',
                container: 'body',
                onConfirm: function (val) {
                    var rowid = $(this).parent().parent().attr("id");
                    delrow(rowid);
                },
                onCancel: function () {
                    //null
                }

            });
            feather.replace();
        });
        feather.replace();
    }

    //删除字段
    function delrow(rowid) {
        var row = $("#" + rowid);
        var key = row.find("#row-key").text();
        alert(key)
    }

    function getTableInfor() {
        var tabledesigninfor = $("#tabledesigninfor");
        tabledesigninfor.empty();
        var params = {cmd: "getTableDesign", tableName: tableName, uid: "000"};
        myutl.ajaxJSONP(baseUrl, params,
            function (result, status, xhr) {
                tabledesign = result;
                var tabledesigninfor = $("#tabledesigninfor");
                tabledesigninfor.empty();

                ///////////////////////////////////////
                var tr = "<tr>";
                tr = tr + "<td ><a class='text-success' data-feather=\"plus-circle\" onclick='addrow()'></a></td>";
                tr = tr + "<td ><input id='new-row-key' class='col-sm' type='text'></div></td>";
                tr = tr + "<td ><input id='new-row-type' type='text' ></td>";
                tr = tr + "<td ><input id='new-row-primarykey' type='checkbox' ></td>";
                tr = tr + "<td ><input id='new-row-cachekey' type='checkbox' ></td>";
                tr = tr + "<td ><input id='new-row-groupkey' name='options-groupkey' autocomplete=\"off\" type='radio' ></td>";
                tr = tr + "<td ><input id='new-row-desc' type='text' ></td>";
                tr = tr + "</tr>";
                // $("#tabledesigninfor").append(tr);
                ///////////////////////////////////////
                var columnsmap = {};
                for (var k in tabledesign.columns) {
                    var d = tabledesign.columns[k];
                    columnsmap[d[0]] = d
                    tr = tr + "<tr id='row-" + k + "'>";
                    tr = tr + "<td ><a class='row-del text-danger' data-feather=\"minus-circle\" data-toggle=\"confirmation\" data-singleton=\"true\" data-title=\"确认要删除?\"></a></td>";
                    tr = tr + "<td id='row-key'>" + d[0] + "</td>";
                    tr = tr + "<td id='row-type'><input value='" + d[1] + "'></td>";
                    tr = tr + "<td id='row-primarykey'><input type='checkbox' " + (isprimarykey(d[0]) ? "checked" : "") + "></td>";
                    tr = tr + "<td id='row-cachekey'><input type='checkbox' " + (iscachekey(d[0]) ? "checked" : "") + "></td>";
                    tr = tr + "<td ><input id='row-groupkey' name='options-groupkey' " + (isgroupkey(d[0]) ? "checked" : "") + " autocomplete=\"off\" type='radio'></td>";
                    tr = tr + "<td ><input id='row-desc' value='" + d[2] + "'></td>";
                    tr = tr + "</tr>";
                }
                tabledesign.columnsmap = columnsmap;
                $("#tabledesigninfor").append(tr).ready(function () {

                    $('[data-toggle=confirmation]').confirmation({
                        rootSelector: '[data-toggle=confirmation]',
                        container: 'body',

                        onConfirm: function (val) {
                            var rowid = $(this).parent().parent().attr("id");
                            delrow(rowid);
                        },
                        onCancel: function () {
                            //null
                        }

                    });
                    feather.replace();
                });

                feather.replace();
            },
            function (jqXHR, textStatus, errorThrown) {
                alert("取得信息失败！");
            });
    }

    function init() {
        getTableInfor();
        feather.replace();
    }

    $(document).ready(init)
</script>

</body>
</html>
